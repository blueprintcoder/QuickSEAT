<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= pageTitle %> - QuickSEAT</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/auth.css">
    <link rel="stylesheet" href="/css/booking-confirmation.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <%- include('../includes/navbar') %> <!-- FIXED: Adjusted path to climb out of the sub-directory -->

    <div class="confirmation-container">
        <div class="confirmation-header">‚úì</div>
        <h2>Booking Successful!</h2>
        <p class="status-badge">Status: Pending Approval</p>

        <% if (locals.success) { %>
            <div class="alert alert-success" style="margin-bottom: 20px;">
                <%= locals.success %>
            </div>
        <% } %>

        <div class="confirmation-card">
            <h3 style="margin-top: 0;"><%= restaurant.name %></h3>
            
            <div class="detail-row">
                <span class="detail-label">Restaurant Address:</span>
                <span><%= restaurant.address %></span>
            </div>

            <div class="detail-row">
                <span class="detail-label">Date & Time:</span>
                <span>
                    <%= new Date(booking.dateTime).toLocaleDateString('en-IN', { month: 'short', day: 'numeric', year: 'numeric' }) %>
                    at 
                    <%= new Date(booking.dateTime).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }) %>
                </span>
            </div>

            <div class="detail-row">
                <span class="detail-label">Party Size:</span>
                <span><%= booking.partySize %> Guests</span>
            </div>
            
            <% if (booking.notes) { %>
            <div class="detail-row">
                <span class="detail-label">Special Notes:</span>
                <span><%= booking.notes %></span>
            </div>
            <% } %>
        </div>

        <p>You will receive an email confirmation once the restaurant approves your booking.</p>

        <div class="action-buttons">
            <a href="/restaurants" class="btn-action btn-home">
                Back to Home
            </a>
            <a href="/my-bookings" class="btn-action btn-bookings">
                View All My Bookings
            </a>
        </div>
    </div>

    <%- include('../includes/footer') %> <!-- FIXED: Adjusted path to climb out of the sub-directory -->

    <script>
        const socket = io({
            transports: ['websocket'],
            reconnectionAttempts: 5
        });

        socket.on("connect_error", (err) => {
            console.error("‚ùå Socket connection error:", err);
        });

        const userId = "<%= user._id %>";
        const currentBookingId = "<%= booking._id %>";

        // Join customer room
        socket.emit("joinCustomer", userId);
        console.log("üîå Connected to socket. Joining room: customer_" + userId);

        socket.on("bookingStatusChanged", (data) => {
            console.log("üì° Status update received:", data);

            // Check if this update is for the current booking
            const eventBookingId = data.bookingId || data.reservationId;
            if (eventBookingId !== currentBookingId) return;

            const status = data.newStatus || data.status; // 'confirmed', 'rejected', 'approved', 'declined'
            
            updateUI(status);
        });

        function updateUI(status) {
            const statusIcon = document.querySelector(".confirmation-header");
            const statusHeading = document.querySelector("h2");
            const statusBadge = document.querySelector(".status-badge");
            const statusMessage = document.querySelector(".confirmation-container > p:last-of-type"); // Selects the paragraph before buttons

            // Normalize status string
            const normalizedStatus = status.toLowerCase();

            if (normalizedStatus === 'confirmed' || normalizedStatus === 'approved') {
                statusIcon.textContent = "‚úì";
                statusIcon.style.backgroundColor = "#2ecc71"; // Green
                statusHeading.textContent = "Booking Confirmed!";
                statusBadge.textContent = "Status: Confirmed";
                statusBadge.style.color = "#2ecc71";
                statusBadge.style.backgroundColor = "#e8f8f0";
                
                if (statusMessage) {
                    statusMessage.textContent = "Your booking has been confirmed by the restaurant! Enjoy your meal.";
                }

                // Optional: Use SweetAlert if available
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'success',
                        title: 'Booking Confirmed!',
                        text: 'The restaurant has accepted your reservation.',
                        timer: 3000,
                        showConfirmButton: false
                    });
                }

            } else if (normalizedStatus === 'rejected' || normalizedStatus === 'declined') {
                statusIcon.textContent = "‚úï";
                statusIcon.style.backgroundColor = "#e74c3c"; // Red
                statusHeading.textContent = "Booking Rejected";
                statusBadge.textContent = "Status: Rejected";
                statusBadge.style.color = "#e74c3c";
                statusBadge.style.backgroundColor = "#fdeaea";
                
                if (statusMessage) {
                    statusMessage.textContent = "Sorry, the restaurant could not accommodate your request at this time.";
                }

                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Booking Rejected',
                        text: 'The restaurant could not accept your reservation.',
                        timer: 3000,
                        showConfirmButton: false
                    });
                }
            }
        }
    </script>
</body>
</html>
