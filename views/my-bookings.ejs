<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Bookings - QuickSEAT</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/auth.css" />
    <script src="/socket.io/socket.io.js"></script>
  </head>

  <body>
    <%- include('./includes/navbar') %>

    <section class="my-bookings-section">
      <div class="container">
        <div class="page-header">
          <h1>My Bookings</h1>
          <p>View and manage your restaurant reservations</p>
        </div>

        <% if (typeof reservations !=='undefined' && reservations.length> 0) {
        %>
        <div class="bookings-grid">
          <% reservations.forEach(reservation=> { const resDate = new
          Date(reservation.dateTime); const isPast = resDate < new Date(); %>
          <div
            class="booking-card <%= reservation.status %> <%= isPast ? 'past' : '' %>"
            data-id="<%= reservation._id %>"
          >
            <div class="booking-header">
              <h3><%= reservation.restaurant.name %></h3>
              <span class="booking-status <%= reservation.status %>">
                <% if (reservation.status === 'pending') { %> ‚è≥ Pending <% }
                else if (reservation.status === 'approved') { %> ‚úì Confirmed <%
                } else if (reservation.status === 'declined') { %> ‚úó Declined <%
                } else { %> üö´ Cancelled <% } %>
              </span>
            </div>

            <div class="booking-details">
              <div class="booking-info-row">
                <span class="info-label">üìç Location:</span>
                <span class="info-value">
                  <%= reservation.restaurant.address %>
                </span>
              </div>
              <div class="booking-info-row">
                <span class="info-label">üìÖ Date:</span>
                <span class="info-value">
                  <%= resDate.toLocaleDateString('en-IN', { weekday: 'long' ,
                  year: 'numeric' , month: 'long' , day: 'numeric' }) %>
                </span>
              </div>
              <div class="booking-info-row">
                <span class="info-label">üïê Time:</span>
                <span class="info-value">
                  <%= resDate.toLocaleTimeString('en-IN', { hour: '2-digit' ,
                  minute: '2-digit' }) %>
                </span>
              </div>
              <div class="booking-info-row">
                <span class="info-label">üë• Guests:</span>
                <span class="info-value"> <%= reservation.partySize %> </span>
              </div>
              <% if (reservation.notes) { %>
              <div class="booking-info-row">
                <span class="info-label">üìù Notes:</span>
                <span class="info-value"> <%= reservation.notes %> </span>
              </div>
              <% } %>
            </div>

            <div class="booking-actions">
              <a
                href="/restaurants/<%= reservation.restaurant._id %>"
                class="btn-booking view"
              >
                View Restaurant
              </a>
              <% if (reservation.status==='approved' && !isPast) { %>
              <button
                class="btn-booking cancel"
                onclick="cancelBooking('<%= reservation._id %>')"
              >
                Cancel Booking
              </button>
              <% } %>
            </div>
          </div>
          <% }) %>
        </div>
        <% } else { %>
        <div class="no-bookings">
          <div class="empty-icon">üìÖ</div>
          <h3>No Bookings Yet</h3>
          <p>You haven't made any restaurant reservations yet.</p>
          <a href="/restaurants" class="btn-primary">Browse Restaurants</a>
        </div>
        <% } %>
      </div>
    </section>

    <%- include('./includes/footer') %>

    <script>
      // ========================
      // SOCKET.IO SETUP
      // ========================
    const customerId = "<%= currentUser._id %>";
    const socket = io();
    socket.emit("joinCustomer", customerId);
        // ‚úÖ DEBUG: Monitor all socket events
socket.onAny((eventName, ...args) => {
  console.log(`üì° Socket event received: ${eventName}`, args);
});

// ‚úÖ DEBUG: Check initial cards
console.log("üìã Initial booking cards:", document.querySelectorAll(".booking-card").length);

        console.log("üìç Joined customer room:", userId);

        // ‚úÖ FIXED: Listen for booking status changes with proper mapping
socket.on("bookingStatusChanged", (data) => {
  console.log("üîÑ Booking status changed:", data);
  
  // Check if this booking belongs to current user
  if (data.customerId && data.customerId !== userId) {
    console.log("‚ö†Ô∏è This booking belongs to a different user. Ignoring.");
    return;
  }

  // Get booking ID (handle different field names)
  const bookingId = data.reservationId || data.bookingId;
  if (!bookingId) {
    console.warn("‚ö†Ô∏è No booking ID in event data");
    return;
  }

  const newStatus = data.status;  // Backend already sends "approved" or "declined"
  
  console.log("‚úÖ Updating my booking:", {
    bookingId: bookingId,
    newStatus: newStatus,
    fullData: data
  });

  // ‚úÖ Map backend status to frontend display status
  const statusMap = {
    'approved': 'approved',
    'declined': 'declined',
    'confirmed': 'approved',  // Map frontend status back
    'rejected': 'declined',
    'cancelled': 'cancelled'
  };

console.log("‚úÖ Updating booking:", bookingId, "‚Üí", newStatus);
  
  // Update the card
  updateBookingCard(bookingId, newStatus);
});

      } else {
        console.log("‚ö†Ô∏è User not logged in");
      }

      // ‚úÖ FIXED: UPDATE BOOKING CARD STATUS
function updateBookingCard(reservationId, newStatus) {
  console.log("üìù updateBookingCard called:", { reservationId, newStatus });
  
  const card = document.querySelector(`[data-id="${reservationId}"]`);
  if (!card) {
    console.warn("‚ö†Ô∏è Card not found for reservation:", reservationId);
    return;
  }

  console.log("‚úÖ Card found! Current class:", card.className);
  console.log("‚úÖ New status to apply:", newStatus);

  // ‚úÖ Update card class (this controls styling)
  card.className = `booking-card ${newStatus}`;
  console.log("‚úÖ Card class updated to:", card.className);

  // ‚úÖ Update status badge
  const statusBadge = card.querySelector(".booking-status");
  if (statusBadge) {
    statusBadge.className = `booking-status ${newStatus}`;

    // Map status to display text (for visual only)
    const statusText = {
      'pending': '‚è≥ Pending',
      'approved': '‚úì Confirmed',      // ‚úÖ "approved" shows as "Confirmed"
      'declined': '‚úó Declined',
      'cancelled': 'üö´ Cancelled'
    };

    statusBadge.textContent = statusText[newStatus] || newStatus;
    console.log("üìù Status badge updated to:", statusBadge.textContent);
  }

  // ‚úÖ Update cancel button visibility
  const cancelBtn = card.querySelector(".btn-booking.cancel");
  if (cancelBtn) {
    if (newStatus === "approved") {
      cancelBtn.style.display = "block";
      console.log("‚úÖ Cancel button shown");
    } else {
      cancelBtn.style.display = "none";
      console.log("‚úÖ Cancel button hidden");
    }
  }

  showNotification(`‚úÖ Booking ${newStatus === 'approved' ? 'confirmed' : newStatus}!`, "success");
  console.log("‚úÖ Card update complete!");
}


      // CANCEL BOOKING
      function cancelBooking(id) {
        if (confirm("Are you sure you want to cancel this booking?")) {
          fetch(`/my-bookings/${id}/cancel`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                console.log("‚úÖ Booking cancelled successfully");
                // Socket.IO will handle the UI update
                showNotification("Booking cancelled successfully!", "success");
              } else {
                console.error("‚ùå Error cancelling booking:", data.error);
                alert("Error cancelling booking");
              }
            })
            .catch((err) => {
              console.error("‚ùå Network error:", err);
              alert("Network error occurred");
            });
        }
      }

      // SHOW NOTIFICATION
      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === "success" ? "#2ecc71" : "#3498db"};
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = "slideOut 0.3s ease";
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }
    </script>

    <style>
      .my-bookings-section {
        background: linear-gradient(
          180deg,
          rgba(245, 247, 255, 0.5) 0%,
          rgba(240, 241, 255, 0.9) 35%,
          rgba(255, 255, 255, 1) 100%
        );
        padding: 4rem 0;
        min-height: calc(100vh - 200px);
      }

      .page-header {
        text-align: center;
        margin-bottom: 3rem;
      }

      .page-header h1 {
        font-size: 2.5rem;
        color: #2c3e50;
        margin-bottom: 0.5rem;
      }

      .page-header p {
        color: #7f8c8d;
        font-size: 1.1rem;
      }

      .bookings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 2rem;
      }

      .booking-card {
        opacity: 0;
        transform: perspective(1000px) translateY(40px) rotateX(5deg)
          scale(0.95);
        transition: all 0.7s cubic-bezier(0.19, 1, 0.22, 1);
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(14px);
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-left: 5px solid #e0e0e0;
        transition: all 0.3s ease;
      }

      .booking-card.visible {
        opacity: 1;
        transform: perspective(1000px) translateY(0) rotateX(0deg) scale(1);
      }

      .booking-card:hover {
        transform: translateY(-10px) scale(1.02);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      }

      .booking-card.pending {
        border-left-color: #f39c12;
      }

      .booking-card.approved {
        border-left-color: #27ae60;
      }

      .booking-card.declined {
        border-left-color: #e74c3c;
      }

      .booking-card.cancelled {
        border-left-color: #95a5a6;
        opacity: 0.7;
      }

      .booking-card.past {
        opacity: 0.7;
      }

      .booking-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f0f0f0;
      }

      .booking-header h3 {
        font-size: 1.5rem;
        color: #2c3e50;
      }

      .booking-status {
        padding: 0.4rem 0.9rem;
        border-radius: 15px;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .booking-status.pending {
        background-color: #fff3cd;
        color: #856404;
      }

      .booking-status.approved {
        background-color: #d4edda;
        color: #155724;
      }

      .booking-status.declined {
        background-color: #f8d7da;
        color: #721c24;
      }

      .booking-status.cancelled {
        background-color: #e2e3e5;
        color: #383d41;
      }

      .booking-details {
        margin-bottom: 1.5rem;
      }

      .booking-info-row {
        display: flex;
        padding: 0.8rem 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .info-label {
        font-weight: 600;
        color: #666;
        min-width: 120px;
      }

      .info-value {
        color: #2c3e50;
      }

      .booking-actions {
        display: flex;
        gap: 0.5rem;
      }

      .btn-booking {
        flex: 1;
        padding: 0.8rem;
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
      }

      .btn-booking.view {
        background: linear-gradient(135deg, #00dbde 0%, #fc00ff 100%);
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn-booking.view:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(252, 0, 255, 0.4);
      }

      .btn-booking.cancel {
        background: linear-gradient(135deg, #ff6a00 0%, #ff3d71 100%);
        color: white;
      }

      .btn-booking.cancel:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(255, 90, 0, 0.4);
      }

      .no-bookings {
        text-align: center;
        padding: 4rem 2rem;
      }

      .empty-icon {
        font-size: 5rem;
        margin-bottom: 1rem;
      }

      .no-bookings h3 {
        font-size: 2rem;
        color: #2c3e50;
        margin-bottom: 1rem;
      }

      .no-bookings p {
        color: #7f8c8d;
        margin-bottom: 2rem;
      }

      /* Animations */
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }

        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }

        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }

      @media (max-width: 768px) {
        .bookings-grid {
          grid-template-columns: 1fr;
        }

        .booking-actions {
          flex-direction: column;
        }
      }
    </style>

    <script>
      const bookingCards = document.querySelectorAll(".booking-card");

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add("visible");
              observer.unobserve(entry.target);
            }
          });
        },
        { threshold: 0.2 }
      );

      bookingCards.forEach((card) => observer.observe(card));

      document.addEventListener('DOMContentLoaded', function() {
        const btn = document.getElementById('mobileMenuBtn');
        const menu = document.getElementById('mobileMenu');

        if (btn) {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                btn.classList.toggle('active');
                menu.classList.toggle('active');
            });
        }

        const links = menu ? menu.querySelectorAll('a') : [];
        links.forEach(link => {
            link.addEventListener('click', function() {
                btn.classList.remove('active');
                menu.classList.remove('active');
            });
        });

        document.addEventListener('click', function(event) {
            if (btn && menu) {
                const inNav = btn.contains(event.target);
                const inMenu = menu.contains(event.target);
                
                if (!inNav && !inMenu) {
                    btn.classList.remove('active');
                    menu.classList.remove('active');
                }
            }
        });
    });
    </script>
  </body>
</html>
